<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market Simulation</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .nav-btn {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            text-decoration: none;
            display: inline-block;
        }
        
        .nav-btn:hover {
            background-color: #2980b9;
        }
        
        .nav-btn.active {
            background-color: #e74c3c;
        }
        
        .section {
            display: none;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .section.active {
            display: block;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }
        
        .currency-selector {
            margin-bottom: 20px;
        }
        
        .currency-selector select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .news-item {
            background-color: #ecf0f1;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        
        .round-selector {
            margin-bottom: 20px;
        }
        
        .round-selector select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .calculator {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .calculator input, .calculator select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .calculator button {
            background-color: #27ae60;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .calculator button:hover {
            background-color: #229954;
        }
        
        .result {
            background-color: #d5f4e6;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border-left: 4px solid #27ae60;
        }
        
        .stock-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .stock-input label {
            min-width: 100px;
        }
        
        .stock-input-enhanced {
            margin-bottom: 15px;
        }
        
        .stock-row {
            display: grid;
            grid-template-columns: 80px 60px 1fr 80px;
            gap: 10px;
            align-items: center;
        }
        
        .price-row {
            display: grid;
            grid-template-columns: 80px 60px 80px;
            gap: 10px;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .price-display {
            background-color: #e8f4fd;
            padding: 5px 8px;
            border-radius: 3px;
            font-weight: bold;
            color: #2980b9;
            font-size: 12px;
            text-align: center;
        }
        
        .cost-display, .revenue-display {
            background-color: #f0f8f0;
            padding: 5px 8px;
            border-radius: 3px;
            font-weight: bold;
            color: #27ae60;
            font-size: 12px;
            text-align: center;
        }
        
        .money-tracker {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }
        
        .tracker-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 3px 0;
        }
        
        .money-left {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .profit-display {
            font-weight: bold;
        }
        
        .profit-display.positive {
            color: #27ae60;
        }
        
        .profit-display.negative {
            color: #e74c3c;
        }
        
        .final-money {
            background-color: #e8f5e8;
            padding: 8px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .error-display {
            background-color: #fadbd8;
            color: #e74c3c;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
            border-left: 4px solid #e74c3c;
        }
        
        .chart-info {
            text-align: center;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-top: 10px;
            color: #6c757d;
            font-style: italic;
        }
        
        .chart-control-btn {
            background-color: #6c757d;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            cursor: pointer;
            margin: 0 2px;
        }
        
        .chart-control-btn:hover {
            background-color: #5a6268;
        }
        
        /* Notification System */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 350px;
        }
        
        .notification {
            background-color: #ffffff;
            border-left: 4px solid #3498db;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 10px;
            padding: 15px;
            cursor: pointer;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .notification:hover {
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            transform: translateX(-2px);
        }
        
        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .notification.chart-update {
            border-left-color: #e74c3c;
        }
        
        .notification.news-update {
            border-left-color: #f39c12;
        }
        
        .notification.chart-load {
            border-left-color: #27ae60;
        }
        
        .notification.news-load {
            border-left-color: #9b59b6;
        }
        
        .notification-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .notification-icon {
            font-size: 18px;
        }
        
        .notification-title {
            font-weight: bold;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .notification-time {
            margin-left: auto;
            font-size: 11px;
            color: #7f8c8d;
        }
        
        .notification-message {
            color: #5a6c7d;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .notification-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 16px;
            color: #bdc3c7;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .notification-close:hover {
            color: #7f8c8d;
        }
        
        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background-color: rgba(52, 152, 219, 0.3);
            width: 100%;
            transform-origin: left;
            animation: progress 10s linear forwards;
        }
        
        @keyframes progress {
            from { transform: scaleX(1); }
            to { transform: scaleX(0); }
        }
        
        .notification:hover .notification-progress {
            animation-play-state: paused;
        }
        
        /* Mobile responsiveness for notifications */
        @media (max-width: 768px) {
            .notification-container {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
            }
            
            .notification {
                margin-bottom: 8px;
                padding: 12px;
            }
            
            .notification-title {
                font-size: 13px;
            }
            
            .notification-message {
                font-size: 12px;
            }
        }
        
        .status {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        
        .status.connected {
            background-color: #d5f4e6;
            color: #27ae60;
        }
        
        .status.disconnected {
            background-color: #fadbd8;
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Stock Market Simulation</h1>
        <div id="status" class="status disconnected">Disconnected</div>
    </div>
    
    <!-- Notification Container -->
    <div id="notificationContainer" class="notification-container"></div>
    
    <div class="container">
        <nav class="nav">
            <button class="nav-btn active" onclick="showSection('chart', true)">Chart</button>
            <button class="nav-btn" onclick="showSection('news', true)">News</button>
            <button class="nav-btn" onclick="showSection('calculator', true)">Calculator</button>
        </nav>
        
        <!-- Chart Section -->
        <section id="chart" class="section active">
            <h2>Stock Prices Chart</h2>
            <div class="currency-selector">
                <label for="currencySelect">Select Currency: </label>
                <select id="currencySelect" onchange="updateChart()">
                    <option value="all">All Currencies</option>
                    <!-- Currency options will be populated dynamically -->
                </select>
            </div>
            <div class="chart-container">
                <canvas id="stockChart"></canvas>
            </div>
            <div class="chart-info">
                <small><strong>💡 Tip:</strong> Click on legend items to toggle currency visibility. All currencies view uses logarithmic scale for better comparison.</small>
                <div id="chartControls" style="margin-top: 5px; display: none;">
                    <button onclick="showAllCurrencies()" class="chart-control-btn">Show All</button>
                    <button onclick="hideAllCurrencies()" class="chart-control-btn">Hide All</button>
                </div>
            </div>
        </section>
        
        <!-- News Section -->
        <section id="news" class="section">
            <h2>Market News</h2>
            <div class="round-selector">
                <label for="newsRoundSelect">Select Round: </label>
                <select id="newsRoundSelect" onchange="showNewsForRound()">
                    <option value="current">Current Round</option>
                </select>
            </div>
            <div id="newsContainer">
                <p>No news available</p>
            </div>
        </section>
        
        <!-- Calculator Section -->
        <section id="calculator" class="section">
            <h2>Dynamic Profit Calculator</h2>
            <div class="calculator">
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
                    <!-- Left Column: Inputs -->
                    <div>
                        <h3>Starting Investment</h3>
                        <label for="initialMoney">Initial Money:</label>
                        <input type="number" id="initialMoney" placeholder="Enter your starting money" oninput="updateCalculation()">
                        
                        <label for="buyRound">Buy Round:</label>
                        <select id="buyRound" onchange="updateCalculation(); updatePriceDisplays();">
                            <option value="0">Round 0</option>
                        </select>
                        
                        <h3>Stock Purchases</h3>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span></span>
                            <button type="button" onclick="clearAllQuantities()" style="background-color: #e74c3c; color: white; border: none; padding: 5px 15px; border-radius: 3px; cursor: pointer; font-size: 12px;">Clear All</button>
                        </div>
                        <div id="stockInputs">
                            <!-- Stock input rows will be populated dynamically -->
                        </div>
                        
                        <label for="sellRound">Sell Round:</label>
                        <select id="sellRound" onchange="updateCalculation(); updatePriceDisplays();">
                            <option value="1">Round 1</option>
                        </select>
                        
                        <h3>Sell Prices</h3>
                        <div id="sellPrices">
                            <!-- Sell price rows will be populated dynamically -->
                        </div>
                    </div>
                    
                    <!-- Right Column: Money Tracker -->
                    <div class="money-tracker">
                        <h3>💰 Money Tracker</h3>
                        <div class="tracker-item">
                            <span>Initial Money:</span>
                            <span id="tracker-initial">$0.00</span>
                        </div>
                        <div class="tracker-item">
                            <span>Total Investment:</span>
                            <span id="tracker-investment">$0.00</span>
                        </div>
                        <div class="tracker-item">
                            <span>Money Left:</span>
                            <span id="tracker-remaining" class="money-left">$0.00</span>
                        </div>
                        <hr style="margin: 10px 0; border-color: #ddd;">
                        <div class="tracker-item">
                            <span>Total Revenue:</span>
                            <span id="tracker-revenue">$0.00</span>
                        </div>
                        <div class="tracker-item">
                            <span>Net Profit:</span>
                            <span id="tracker-profit" class="profit-display">$0.00</span>
                        </div>
                        <div class="tracker-item final-money">
                            <span><strong>Final Money:</strong></span>
                            <span id="tracker-final"><strong>$0.00</strong></span>
                        </div>
                    </div>
                </div>
                
                <div id="calculationErrors" class="error-display" style="display: none;"></div>
            </div>
        </section>
    </div>
    
    <script>
        let stockData = {};
        let newsData = {};
        let chart = null;
        let eventSource = null;
        let availableCurrencies = [];
        let notificationId = 0;
        let initialLoadComplete = {chart: false, news: false};
        
        // Notification System
        function createNotification(type, title, message, icon, clickAction = null) {
            const container = document.getElementById('notificationContainer');
            const id = ++notificationId;
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.id = `notification-${id}`;
            
            const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            notification.innerHTML = `
                <button class="notification-close" onclick="dismissNotification(${id})" title="Close">×</button>
                <div class="notification-header">
                    <span class="notification-icon">${icon}</span>
                    <span class="notification-title">${title}</span>
                    <span class="notification-time">${currentTime}</span>
                </div>
                <div class="notification-message">${message}</div>
                <div class="notification-progress"></div>
            `;
            
            // Add click handler - either custom action or dismiss
            notification.addEventListener('click', (e) => {
                // Don't trigger action if clicking the close button
                if (e.target.classList.contains('notification-close')) {
                    return;
                }
                
                if (clickAction) {
                    clickAction();
                    dismissNotification(id);
                } else {
                    dismissNotification(id);
                }
            });
            
            container.appendChild(notification);
            
            // Trigger animation
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            // Auto dismiss after 10 seconds
            setTimeout(() => {
                dismissNotification(id);
            }, 10000);
            
            return id;
        }
        
        function dismissNotification(id) {
            const notification = document.getElementById(`notification-${id}`);
            if (notification) {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }
        
        function showChartUpdateNotification(data) {
            const roundKeys = Object.keys(data);
            const roundsText = roundKeys.length > 1 
                ? `rounds ${roundKeys.join(', ')}` 
                : `round ${roundKeys[0]}`;
            
            createNotification(
                'chart-update',
                'Chart Data Updated',
                `New price data available for ${roundsText}. Click to view chart.`,
                '📈',
                () => showSection('chart')
            );
        }
        
        function showChartLoadNotification(data) {
            const roundCount = Object.keys(data).length;
            createNotification(
                'chart-load',
                'Chart Data Loaded',
                `Price history loaded for ${roundCount} round${roundCount !== 1 ? 's' : ''}. Click to view chart.`,
                '📊',
                () => showSection('chart')
            );
        }
        
        function showNewsUpdateNotification(data) {
            const roundKeys = Object.keys(data);
            const newsCount = Object.values(data).reduce((total, news) => total + (news ? news.length : 0), 0);
            
            createNotification(
                'news-update',
                'News Published',
                `${newsCount} new news item${newsCount !== 1 ? 's' : ''} published. Click to read news.`,
                '📰',
                () => {
                    showSection('news');
                    // Set news selector to current round and update display
                    const newsSelect = document.getElementById('newsRoundSelect');
                    if (newsSelect) {
                        newsSelect.value = 'current';
                        showNewsForRound();
                    }
                }
            );
        }
        
        function showNewsLoadNotification(data) {
            const newsCount = Object.values(data).reduce((total, news) => total + (news ? news.length : 0), 0);
            createNotification(
                'news-load',
                'News History Loaded',
                `${newsCount} news item${newsCount !== 1 ? 's' : ''} loaded. Click to read news.`,
                '📋',
                () => {
                    showSection('news');
                    // Set news selector to current round and update display
                    const newsSelect = document.getElementById('newsRoundSelect');
                    if (newsSelect) {
                        newsSelect.value = 'current';
                        showNewsForRound();
                    }
                }
            );
        }

        // Initialize the application
        function init() {
            initChart();
            loadCurrencies().then(() => {
                connectToStream();
            }).catch(error => {
                console.error('Failed to load currencies:', error);
                // Use fallback currencies
                availableCurrencies = ['Apple', 'Google', 'РосАтом', 'BitCoin'];
                connectToStream();
            });
        }
        
        async function loadCurrencies() {
            try {
                const response = await fetch('/api/currencies');
                if (!response.ok) throw new Error('Failed to fetch currencies');
                const data = await response.json();
                availableCurrencies = data.currencies;
                console.log('Loaded currencies:', availableCurrencies);
                updateCurrencySelector();
                setupCalculatorCurrencies();
            } catch (error) {
                console.error('Error loading currencies:', error);
                throw error;
            }
        }
        
        function initChart() {
            const ctx = document.getElementById('stockChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Price'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Round'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            onClick: (e, legendItem, legend) => {
                                // Toggle visibility of the dataset
                                const index = legendItem.datasetIndex;
                                const ci = legend.chart;
                                const meta = ci.getDatasetMeta(index);
                                const dataset = ci.data.datasets[index];
                                
                                // Toggle dataset visibility
                                meta.hidden = meta.hidden === null ? !dataset.hidden : !meta.hidden;
                                
                                // Save visibility state for this currency
                                const currency = dataset.label;
                                datasetVisibility[currency] = meta.hidden;
                                
                                // Update the legend item style
                                legendItem.hidden = meta.hidden;
                                
                                // Re-render the chart
                                ci.update();
                            },
                            onHover: (e, legendItem) => {
                                e.native.target.style.cursor = 'pointer';
                            },
                            onLeave: (e, legendItem) => {
                                e.native.target.style.cursor = 'default';
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    return `${context.dataset.label}: $${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }
        
        function connectToStream() {
            eventSource = new EventSource('/stream');
            
            eventSource.onopen = function(event) {
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = 'Connected';
                
                // Show connection notification
                createNotification(
                    'chart-load',
                    'Connected',
                    'Successfully connected to live market data stream',
                    '🟢'
                );
            };
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    handleStreamData(data);
                } catch (e) {
                    console.error('Error parsing stream data:', e);
                }
            };
            
            eventSource.onerror = function(event) {
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('status').textContent = 'Disconnected';
                
                // Show disconnection notification
                createNotification(
                    'news-update', // Using orange color for warning
                    'Connection Lost',
                    'Lost connection to market data stream. Attempting to reconnect...',
                    '🔴'
                );
            };
        }
        
        function handleStreamData(data) {
            if (data.data_type === 'chart') {
                if (data.event_type === 'load') {
                    stockData = data.data;
                    updateChart();
                    updateRoundSelectors();
                    // Show notification for chart data load only on first load
                    if (!initialLoadComplete.chart) {
                        showChartLoadNotification(data.data);
                        initialLoadComplete.chart = true;
                    }
                } else if (data.event_type === 'update') {
                    Object.assign(stockData, data.data);
                    updateChart();
                    updateRoundSelectors();
                    // Always show notification for chart data updates
                    showChartUpdateNotification(data.data);
                }
            } else if (data.data_type === 'news') {
                if (data.event_type === 'load') {
                    newsData = data.data;
                    updateNewsRoundSelector();
                    showNewsForRound();
                    // Show notification for news data load only on first load
                    if (!initialLoadComplete.news) {
                        showNewsLoadNotification(data.data);
                        initialLoadComplete.news = true;
                    }
                } else if (data.event_type === 'update') {
                    Object.assign(newsData, data.data);
                    updateNewsRoundSelector();
                    showNewsForRound();
                    // Always show notification for news updates
                    showNewsUpdateNotification(data.data);
                }
            }
        }
        
        function updateCurrencySelector() {
            const select = document.getElementById('currencySelect');
            const currentValue = select.value;
            
            // Clear existing options except "All Currencies"
            select.innerHTML = '<option value="all">All Currencies</option>';
            
            // Add currency options
            availableCurrencies.forEach(currency => {
                const option = document.createElement('option');
                option.value = currency;
                option.textContent = currency;
                select.appendChild(option);
            });
            
            // Restore selection if it still exists
            if (availableCurrencies.includes(currentValue) || currentValue === 'all') {
                select.value = currentValue;
            }
        }
        
        function setupCalculatorCurrencies() {
            const stockInputsContainer = document.getElementById('stockInputs');
            const sellPricesContainer = document.getElementById('sellPrices');
            
            // Clear existing content
            stockInputsContainer.innerHTML = '';
            sellPricesContainer.innerHTML = '';
            
            // Create stock input rows
            availableCurrencies.forEach(currency => {
                const currencyKey = currency.toLowerCase().replace(/[^a-z0-9]/g, '');
                
                // Stock purchase row
                const stockInputDiv = document.createElement('div');
                stockInputDiv.className = 'stock-input-enhanced';
                stockInputDiv.innerHTML = `
                    <div class="stock-row">
                        <label>${currency}:</label>
                        <span id="${currencyKey}-buy-price" class="price-display">$0</span>
                        <input type="number" id="${currencyKey}-qty" placeholder="Qty" min="0" oninput="updateCalculation()">
                        <span id="${currencyKey}-cost" class="cost-display">$0</span>
                    </div>
                `;
                stockInputsContainer.appendChild(stockInputDiv);
                
                // Sell price row
                const sellPriceDiv = document.createElement('div');
                sellPriceDiv.className = 'price-row';
                sellPriceDiv.innerHTML = `
                    <label>${currency}:</label>
                    <span id="${currencyKey}-sell-price" class="price-display">$0</span>
                    <span id="${currencyKey}-revenue" class="revenue-display">$0</span>
                `;
                sellPricesContainer.appendChild(sellPriceDiv);
            });
        }
        
        // Store dataset visibility state
        let datasetVisibility = {};
        
        function updateChart() {
            const selectedCurrency = document.getElementById('currencySelect').value;
            const rounds = Object.keys(stockData).sort((a, b) => parseInt(a) - parseInt(b));
            
            chart.data.labels = rounds.map(r => `Round ${r}`);
            
            if (selectedCurrency === 'all') {
                const colors = ['#e74c3c', '#f39c12', '#2ecc71', '#3498db', '#9b59b6', '#1abc9c', '#f1c40f', '#e67e22'];
                
                chart.data.datasets = availableCurrencies.map((currency, index) => ({
                    label: currency,
                    data: rounds.map(round => stockData[round] ? stockData[round][currency] : 0),
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    tension: 0.1,
                    hidden: datasetVisibility[currency] || false // Restore previous visibility state
                }));
                
                // Set logarithmic scale for all currencies view
                chart.options.scales.y.type = 'logarithmic';
                chart.options.scales.y.beginAtZero = false;
                chart.options.scales.y.title.text = 'Price (Log Scale)';
                chart.options.scales.y.ticks = {
                    callback: function(value, index, values) {
                        // Format the tick labels to show actual values
                        if (value >= 1000) {
                            return '$' + (value / 1000).toFixed(0) + 'k';
                        } else if (value >= 100) {
                            return '$' + value.toFixed(0);
                        } else if (value >= 10) {
                            return '$' + value.toFixed(1);
                        } else {
                            return '$' + value.toFixed(2);
                        }
                    }
                };
                
                // Show chart controls for all currencies view
                document.getElementById('chartControls').style.display = 'block';
            } else {
                chart.data.datasets = [{
                    label: selectedCurrency,
                    data: rounds.map(round => stockData[round] ? stockData[round][selectedCurrency] : 0),
                    borderColor: '#3498db',
                    backgroundColor: '#3498db20',
                    tension: 0.1,
                    pointBackgroundColor: '#3498db',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 4
                }];
                
                // Set linear scale for single currency view
                chart.options.scales.y.type = 'linear';
                chart.options.scales.y.beginAtZero = true;
                chart.options.scales.y.title.text = 'Price';
                chart.options.scales.y.ticks = {
                    callback: function(value, index, values) {
                        return '$' + value;
                    }
                };
                
                // Hide chart controls for single currency view
                document.getElementById('chartControls').style.display = 'none';
            }
            
            chart.update();
        }
        
        function showAllCurrencies() {
            if (chart && chart.data.datasets) {
                chart.data.datasets.forEach((dataset, index) => {
                    const meta = chart.getDatasetMeta(index);
                    meta.hidden = false;
                    datasetVisibility[dataset.label] = false;
                });
                chart.update();
            }
        }
        
        function hideAllCurrencies() {
            if (chart && chart.data.datasets) {
                chart.data.datasets.forEach((dataset, index) => {
                    const meta = chart.getDatasetMeta(index);
                    meta.hidden = true;
                    datasetVisibility[dataset.label] = true;
                });
                chart.update();
            }
        }
        
        function updateRoundSelectors() {
            const rounds = Object.keys(stockData).sort((a, b) => parseInt(a) - parseInt(b));
            
            const buySelect = document.getElementById('buyRound');
            const sellSelect = document.getElementById('sellRound');
            
            const currentBuyValue = buySelect.value;
            const currentSellValue = sellSelect.value;
            
            buySelect.innerHTML = '';
            sellSelect.innerHTML = '';
            
            rounds.forEach(round => {
                buySelect.innerHTML += `<option value="${round}">Round ${round}</option>`;
                sellSelect.innerHTML += `<option value="${round}">Round ${round}</option>`;
            });
            
            // Restore previous selections if they still exist
            if (rounds.includes(currentBuyValue)) {
                buySelect.value = currentBuyValue;
            }
            if (rounds.includes(currentSellValue)) {
                sellSelect.value = currentSellValue;
            }
            
            // Update price displays and calculations
            updatePriceDisplays();
            updateCalculation();
        }
        
        function updateNewsRoundSelector() {
            const rounds = Object.keys(newsData).sort((a, b) => parseInt(a) - parseInt(b));
            const select = document.getElementById('newsRoundSelect');
            
            const currentValue = select.value;
            select.innerHTML = '<option value="current">Current Round</option>';
            
            rounds.forEach(round => {
                select.innerHTML += `<option value="${round}">Round ${round}</option>`;
            });
            
            select.value = currentValue;
        }
        
        function showNewsForRound() {
            const selectedRound = document.getElementById('newsRoundSelect').value;
            const container = document.getElementById('newsContainer');
            
            let news = [];
            if (selectedRound === 'current') {
                const maxRound = Math.max(...Object.keys(newsData).map(r => parseInt(r)));
                news = newsData[maxRound] || [];
            } else {
                news = newsData[selectedRound] || [];
            }
            
            if (news.length === 0) {
                container.innerHTML = '<p>No news available for this round</p>';
            } else {
                container.innerHTML = news.map(item => 
                    `<div class="news-item">${item}</div>`
                ).join('');
            }
        }
        
        function updatePriceDisplays() {
            const buyRound = document.getElementById('buyRound').value;
            const sellRound = document.getElementById('sellRound').value;
            
            try {
                if (!stockData || Object.keys(stockData).length === 0) {
                    throw new Error('No chart data available');
                }
                
                if (!stockData[buyRound] || !stockData[sellRound]) {
                    throw new Error('Selected rounds not available in data');
                }
                
                const buyPrices = stockData[buyRound];
                const sellPrices = stockData[sellRound];
                
                availableCurrencies.forEach(currency => {
                    const currencyKey = currency.toLowerCase().replace(/[^a-z0-9]/g, '');
                    const buyPrice = buyPrices[currency] || 0;
                    const sellPrice = sellPrices[currency] || 0;
                    
                    const buyPriceElement = document.getElementById(`${currencyKey}-buy-price`);
                    const sellPriceElement = document.getElementById(`${currencyKey}-sell-price`);
                    
                    if (buyPriceElement) buyPriceElement.textContent = `$${buyPrice}`;
                    if (sellPriceElement) sellPriceElement.textContent = `$${sellPrice}`;
                });
                
                hideError();
            } catch (error) {
                showError(error.message);
            }
        }
        
        function updateCalculation() {
            const initialMoney = parseFloat(document.getElementById('initialMoney').value) || 0;
            const buyRound = document.getElementById('buyRound').value;
            const sellRound = document.getElementById('sellRound').value;
            
            // Build quantities object dynamically
            const quantities = {};
            availableCurrencies.forEach(currency => {
                const currencyKey = currency.toLowerCase().replace(/[^a-z0-9]/g, '');
                const qtyInput = document.getElementById(`${currencyKey}-qty`);
                quantities[currency] = qtyInput ? (parseFloat(qtyInput.value) || 0) : 0;
            });
            
            try {
                if (!stockData || Object.keys(stockData).length === 0) {
                    throw new Error('No chart data available. Please wait for data to load.');
                }
                
                if (!stockData[buyRound] || !stockData[sellRound]) {
                    throw new Error('Selected rounds not available in local data');
                }
                
                const buyPrices = stockData[buyRound];
                const sellPrices = stockData[sellRound];
                
                let totalCost = 0;
                let totalRevenue = 0;
                
                // Update individual stock costs and revenues
                Object.keys(quantities).forEach(currency => {
                    const qty = quantities[currency];
                    const currencyKey = currency.toLowerCase().replace(/[^a-z0-9]/g, '');
                    const buyPrice = buyPrices[currency] || 0;
                    const sellPrice = sellPrices[currency] || 0;
                    
                    const cost = qty * buyPrice;
                    const revenue = qty * sellPrice;
                    
                    totalCost += cost;
                    totalRevenue += revenue;
                    
                    const costElement = document.getElementById(`${currencyKey}-cost`);
                    const revenueElement = document.getElementById(`${currencyKey}-revenue`);
                    
                    if (costElement) costElement.textContent = `$${cost.toFixed(2)}`;
                    if (revenueElement) revenueElement.textContent = `$${revenue.toFixed(2)}`;
                });
                
                const moneyLeft = initialMoney - totalCost;
                const totalProfit = totalRevenue - totalCost;
                const finalMoney = initialMoney - totalCost + totalRevenue;
                
                // Update money tracker
                document.getElementById('tracker-initial').textContent = `$${initialMoney.toFixed(2)}`;
                document.getElementById('tracker-investment').textContent = `$${totalCost.toFixed(2)}`;
                document.getElementById('tracker-remaining').textContent = `$${moneyLeft.toFixed(2)}`;
                document.getElementById('tracker-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
                document.getElementById('tracker-profit').textContent = `$${totalProfit.toFixed(2)}`;
                document.getElementById('tracker-final').textContent = `$${finalMoney.toFixed(2)}`;
                
                // Color coding for money left and profit
                const moneyLeftElement = document.getElementById('tracker-remaining');
                moneyLeftElement.className = moneyLeft >= 0 ? 'money-left positive' : 'money-left negative';
                if (moneyLeft < 0) {
                    moneyLeftElement.style.color = '#e74c3c';
                } else {
                    moneyLeftElement.style.color = '#27ae60';
                }
                
                const profitElement = document.getElementById('tracker-profit');
                profitElement.className = totalProfit >= 0 ? 'profit-display positive' : 'profit-display negative';
                
                hideError();
                
            } catch (error) {
                showError(error.message);
                
                // Reset displays on error
                availableCurrencies.forEach(currency => {
                    const currencyKey = currency.toLowerCase().replace(/[^a-z0-9]/g, '');
                    const costElement = document.getElementById(`${currencyKey}-cost`);
                    const revenueElement = document.getElementById(`${currencyKey}-revenue`);
                    
                    if (costElement) costElement.textContent = '$0.00';
                    if (revenueElement) revenueElement.textContent = '$0.00';
                });
                
                ['tracker-initial', 'tracker-investment', 'tracker-remaining', 
                 'tracker-revenue', 'tracker-profit', 'tracker-final'].forEach(id => {
                    document.getElementById(id).textContent = '$0.00';
                });
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('calculationErrors');
            errorDiv.style.display = 'block';
            errorDiv.innerHTML = `<strong>Error:</strong> ${message}`;
        }
        
        function hideError() {
            document.getElementById('calculationErrors').style.display = 'none';
        }
        
        function clearAllQuantities() {
            // Clear all stock quantity inputs
            availableCurrencies.forEach(currency => {
                const currencyKey = currency.toLowerCase().replace(/[^a-z0-9]/g, '');
                const qtyInput = document.getElementById(`${currencyKey}-qty`);
                if (qtyInput) {
                    qtyInput.value = '';
                }
            });
            
            // Update calculations to reflect cleared quantities
            updateCalculation();
        }
        
        function showSection(sectionName, updateNavigation = true) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionName).classList.add('active');
            
            // Update navigation buttons if requested
            if (updateNavigation) {
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Find and activate the corresponding nav button
                const navButtons = document.querySelectorAll('.nav-btn');
                const sectionIndex = {'chart': 0, 'news': 1, 'calculator': 2}[sectionName];
                if (sectionIndex !== undefined && navButtons[sectionIndex]) {
                    navButtons[sectionIndex].classList.add('active');
                }
            }
        }
        
        // Initialize when page loads
        window.onload = init;
    </script>
</body>
</html>